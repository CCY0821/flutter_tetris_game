# 惡魔方塊系統 - 任務檢查清單

**版本**: 1.0
**日期**: 2025-11-01
**總任務數**: 25 個子階段

---

## 📋 進度總覽

- **階段 1**: [ ] 0/5 完成
- **階段 2**: [ ] 0/5 完成
- **階段 3**: [ ] 0/5 完成
- **階段 4**: [ ] 0/5 完成
- **階段 5**: [ ] 0/5 完成
- **總進度**: 0/25 (0%)

---

## 🚀 階段 1：核心數據結構 (1.5-2h)

### 1.1 新增 DEMON 枚舉與顏色定義 (15min)
- [ ] 1.1.1 在 `tetromino_definitions.dart` 新增 `TetrominoType.DEMON` 枚舉值
- [ ] 1.1.2 新增 DEMON 顏色定義 (金色 `Color(0xFFFFD700)`)
- [ ] 1.1.3 在顏色 Map 中註冊 DEMON 類型
- [ ] 1.1.4 驗證枚舉可正確訪問
- **驗收**: `TetrominoType.DEMON` 枚舉存在且有顏色定義

### 1.2 建立 DemonPieceGenerator 基礎架構 (20min)
- [ ] 1.2.1 創建 `lib/game/demon_piece_generator.dart` 檔案
- [ ] 1.2.2 定義類別結構與公開 API (`generateShape` 方法簽名)
- [ ] 1.2.3 實現 `_floodFillGenerate` 洪水填充核心邏輯
- [ ] 1.2.4 實現 `_getAvailableNeighbors` 擴展方法 (均等機率)
- **驗收**: 能夠生成基本的連續方塊 (暫不驗證)

### 1.3 實現驗證機制 (25min)
- [ ] 1.3.1 實現 `_isConnected` 連通性驗證 (DFS/BFS)
- [ ] 1.3.2 實現 `_canBePlacedOnEmptyBoard` 智能驗證
- [ ] 1.3.3 實現 `_generateFallbackShape` 降級方案 (2×5 矩形)
- [ ] 1.3.4 整合所有驗證到 `generateShape` 主方法 (10次重試邏輯)
- **驗收**: 生成的方塊通過連通性與寬度驗證

### 1.4 擴展 Tetromino 支援動態矩陣 (30min)
- [ ] 1.4.1 修改 `Tetromino` 類別支援動態 `List<List<bool>>` 大小
- [ ] 1.4.2 新增 `Tetromino.demon()` 建構函式 (調用 DemonPieceGenerator)
- [ ] 1.4.3 修改 `rotate()` 方法 (DEMON 類型返回自身)
- [ ] 1.4.4 更新 `getBoundingBox()` 方法支援 5×5 計算
- **驗收**: `Tetromino.demon()` 能成功創建且無法旋轉

### 1.5 單元測試與驗證 (20min)
- [ ] 1.5.1 編寫測試：生成 100 次方塊，驗證都是 10 格
- [ ] 1.5.2 編寫測試：驗證所有生成的方塊連通
- [ ] 1.5.3 編寫測試：驗證方塊寬度不超過 10
- [ ] 1.5.4 編寫測試：驗證惡魔方塊旋轉返回自身
- [ ] 1.5.5 執行所有測試確保通過
- **驗收**: 所有單元測試通過

---

## ⚡ 階段 2：觸發系統 (1-2h)

### 2.1 實現 DemonSpawnManager 核心邏輯 (20min)
- [ ] 2.1.1 創建 `lib/game/demon_spawn_manager.dart` 檔案
- [ ] 2.1.2 實現 `getNextThreshold()` 門檻計算 (n^1.2，最大15次)
- [ ] 2.1.3 實現 `shouldSpawn()` 觸發檢測邏輯
- [ ] 2.1.4 實現 `reset()` 重置方法
- [ ] 2.1.5 新增 `spawnCount` getter
- **驗收**: DemonSpawnManager 能正確計算門檻值

### 2.2 擴展 GameState 狀態管理 (25min)
- [ ] 2.2.1 在 `game_state.dart` 新增4個欄位 (demonSpawnCount, scoreMultiplier, multiplierEndTime, _pausedMultiplierRemaining)
- [ ] 2.2.2 實現 `startScoreMultiplier()` 方法 (支援疊加邏輯)
- [ ] 2.2.3 實現 `checkMultiplierExpiry()` 方法
- [ ] 2.2.4 修改 `pauseGame()` 與 `resumeGame()` 方法 (計時器暫停邏輯)
- [ ] 2.2.5 修改 `resetGame()` 方法 (歸零計數器)
- **驗收**: GameState 能正確管理加成狀態

### 2.3 整合 DemonSpawnManager 到 GameState (15min)
- [ ] 2.3.1 在 GameState 中創建 `_demonSpawnManager` 實例
- [ ] 2.3.2 在分數更新時調用 `_demonSpawnManager.shouldSpawn()`
- [ ] 2.3.3 觸發時發送通知給 GameLogic
- [ ] 2.3.4 在 resetGame 時調用 `_demonSpawnManager.reset()`
- **驗收**: 達到門檻時能正確觸發通知

### 2.4 修改 PieceProvider 插入惡魔方塊 (20min)
- [ ] 2.4.1 在 `piece_provider.dart` 新增 `insertDemonPiece()` 方法
- [ ] 2.4.2 實現插入邏輯 (插入到佇列頂部)
- [ ] 2.4.3 在 GameLogic 中監聽觸發通知
- [ ] 2.4.4 調用 `pieceProvider.insertDemonPiece()`
- [ ] 2.4.5 驗證下一個方塊確實為 DEMON
- **驗收**: 觸發時下一個方塊變為惡魔方塊

### 2.5 實現計時器與單元測試 (20min)
- [ ] 2.5.1 在 GameLogic 中檢測方塊放置類型 (lockPiece 方法)
- [ ] 2.5.2 如果是 DEMON，調用 `gameState.startScoreMultiplier()`
- [ ] 2.5.3 在遊戲循環中調用 `gameState.checkMultiplierExpiry()`
- [ ] 2.5.4 編寫測試：驗證前 15 個門檻值正確
- [ ] 2.5.5 編寫測試：驗證疊加邏輯與暫停邏輯
- **驗收**: 所有單元測試通過

---

## 🎨 階段 3：視覺效果 (2.5-3h)

### 3.1 實現惡魔方塊徑向漸層渲染 (35min)
- [ ] 3.1.1 在 `tetromino_painter.dart` 新增 `_paintDemonCell()` 方法
- [ ] 3.1.2 實現徑向漸層 Shader (金色 #FFD700 → 紅色 #DC143C)
- [ ] 3.1.3 實現深紅色邊框 (#8B0000，2px)
- [ ] 3.1.4 在 `paint()` 方法中檢測 DEMON 類型並調用新方法
- [ ] 3.1.5 測試漸層效果 (視覺確認)
- **驗收**: 惡魔方塊顯示金紅漸層與深紅邊框

### 3.2 實現幽靈方塊預覽系統 (40min)
- [ ] 3.2.1 在 `touch_controls.dart` 新增 `_calculateGhostPiece()` 方法
- [ ] 3.2.2 實現硬降模擬邏輯 (複製方塊後循環 moveDown)
- [ ] 3.2.3 實現幽靈方塊繪製 (半透明 opacity: 0.3-0.4)
- [ ] 3.2.4 整合到主繪製流程 (在當前方塊下方繪製)
- [ ] 3.2.5 測試所有方塊類型 (包含 DEMON)
- **驗收**: 幽靈方塊正確顯示所有方塊的落點

### 3.3 實現 Next Piece 預警動畫 (30min)
- [ ] 3.3.1 在 `touch_controls.dart` 新增 AnimationController (1.0秒週期)
- [ ] 3.3.2 檢測 nextPiece 是否為 DEMON
- [ ] 3.3.3 實現紅色脈動光環 (Opacity 0.5 ↔ 1.0)
- [ ] 3.3.4 顯示警告文字「⚠️ 惡魔方塊」(紅色粗體)
- [ ] 3.3.5 測試動畫效果 (視覺確認)
- **驗收**: Next Piece 為 DEMON 時顯示脈動預警

### 3.4 創建分數加成計時器 UI (45min)
- [ ] 3.4.1 創建 `lib/game/multiplier_timer_widget.dart` 檔案
- [ ] 3.4.2 實現倒數計時顯示 (監聽 GameState.multiplierEndTime)
- [ ] 3.4.3 實現進度條動畫 (紅到黃漸層，遞減效果)
- [ ] 3.4.4 實現最後 3 秒閃爍效果 (0.5秒週期)
- [ ] 3.4.5 整合到遊戲 UI (分數下方)
- **驗收**: 計時器清晰顯示剩餘時間與進度條

### 3.5 旋轉按鈕禁用與整合測試 (20min)
- [ ] 3.5.1 在 `touch_controls.dart` 檢測當前方塊類型
- [ ] 3.5.2 如果是 DEMON，旋轉按鈕變灰色 (opacity: 0.5)
- [ ] 3.5.3 禁用旋轉按鈕點擊 (ignorePointer)
- [ ] 3.5.4 整合測試所有視覺效果
- [ ] 3.5.5 性能測試 (確保 60 FPS)
- **驗收**: 旋轉按鈕在惡魔方塊時正確禁用

---

## 🔍 階段 4：遊戲邏輯整合 (1-2h)

### 4.1 整合分數乘數系統 (25min)
- [ ] 4.1.1 在 `scoring.dart` 找到所有分數計算位置
- [ ] 4.1.2 修改單行/多行消除分數計算 (乘以 scoreMultiplier)
- [ ] 4.1.3 修改連擊加成 (Combo) 分數計算
- [ ] 4.1.4 修改軟降/硬降分數計算
- [ ] 4.1.5 測試加成期間分數正確 (手動驗證)
- **驗收**: 加成期間所有分數正確 ×3

### 4.2 整合計時器到遊戲循環 (20min)
- [ ] 4.2.1 在 `game_logic.dart` 的 game loop 中調用 `checkMultiplierExpiry()`
- [ ] 4.2.2 確保每幀都檢查 (或使用 Timer)
- [ ] 4.2.3 測試計時器精準度 (誤差 < 100ms)
- [ ] 4.2.4 處理計時器到期時的 UI 更新
- [ ] 4.2.5 測試疊加情況下計時器正確性
- **驗收**: 計時器到期後立即恢復 multiplier = 1.0

### 4.3 處理暫停與恢復邏輯 (15min)
- [ ] 4.3.1 驗證 `pauseGame()` 正確保存剩餘時間
- [ ] 4.3.2 驗證 `resumeGame()` 正確恢復計時器
- [ ] 4.3.3 測試暫停期間分數不累積
- [ ] 4.3.4 測試多次暫停/恢復的穩定性
- [ ] 4.3.5 處理暫停時 UI 顯示
- **驗收**: 暫停/恢復不影響計時器準確性

### 4.4 處理 Game Over 與重啟邏輯 (20min)
- [ ] 4.4.1 在 Game Over 時調用 `gameState.resetGame()`
- [ ] 4.4.2 驗證 `demonSpawnCount` 歸零
- [ ] 4.4.3 驗證 `scoreMultiplier` 重置為 1.0
- [ ] 4.4.4 驗證 `_demonSpawnManager.reset()` 被調用
- [ ] 4.4.5 測試重啟後第一個惡魔方塊在 10,000 分觸發
- **驗收**: Game Over 後所有狀態正確重置

### 4.5 邊界情況測試與修復 (20min)
- [ ] 4.5.1 測試連續放置 3 個惡魔方塊的疊加情況
- [ ] 4.5.2 測試在加成期間 Game Over 的處理
- [ ] 4.5.3 測試達到 15 次上限後不再觸發
- [ ] 4.5.4 測試記憶體洩漏 (Timer 正確釋放)
- [ ] 4.5.5 修復發現的所有 bug
- **驗收**: 所有邊界情況正確處理

---

## 🧪 階段 5：測試與平衡 (2-3h)

### 5.1 完整功能測試 (35min)
- [ ] 5.1.1 手動測試：從 0 分玩到第一個惡魔方塊 (10,000 分)
- [ ] 5.1.2 驗證惡魔方塊生成形狀多樣性 (重複生成 20 次)
- [ ] 5.1.3 驗證所有生成的形狀可放置 (無極端情況)
- [ ] 5.1.4 驗證分數加成正確 (×3)
- [ ] 5.1.5 記錄功能測試結果 (截圖/影片)
- **驗收**: 所有核心功能正常運作

### 5.2 性能基準測試 (25min)
- [ ] 5.2.1 測試惡魔方塊生成時間 (應 < 50ms)
- [ ] 5.2.2 測試渲染幀率 (FPS 監控，應維持 60 FPS)
- [ ] 5.2.3 測試記憶體使用 (玩 30 分鐘，觀察記憶體趨勢)
- [ ] 5.2.4 測試計時器無記憶體洩漏 (重複觸發 10 次)
- [ ] 5.2.5 優化性能瓶頸 (如有)
- **驗收**: 所有性能指標達標

### 5.3 難度曲線平衡 (40min)
- [ ] 5.3.1 測試第一個惡魔方塊出現時間 (應在 5-8 分鐘)
- [ ] 5.3.2 測試連續觸發間隔 (觀察 n^1.2 曲線是否合理)
- [ ] 5.3.3 調整觸發公式 (如需要，改為 n^1.15 或 n^1.25)
- [ ] 5.3.4 測試 15 次上限是否合理 (長時間遊戲體驗)
- [ ] 5.3.5 記錄最終平衡參數
- **驗收**: 難度曲線符合設計預期

### 5.4 邊界情況壓力測試 (30min)
- [ ] 5.4.1 測試降級方案觸發頻率 (10 次重試是否足夠)
- [ ] 5.4.2 測試連續 3 個惡魔方塊疊加 (30 秒計時器)
- [ ] 5.4.3 測試加成期間暫停/恢復多次
- [ ] 5.4.4 測試達到 15 次上限後的行為
- [ ] 5.4.5 測試快速重啟遊戲 (狀態清空)
- **驗收**: 所有邊界情況穩定無崩潰

### 5.5 最終驗收與文檔 (20min)
- [ ] 5.5.1 執行完整遊戲流程 (0 分 → Game Over)
- [ ] 5.5.2 記錄所有發現的 bug (如有)
- [ ] 5.5.3 更新設計文檔 (標記實際參數)
- [ ] 5.5.4 創建測試報告 (性能數據、平衡參數)
- [ ] 5.5.5 提交程式碼與文檔
- **驗收**: 系統完整可發布

---

## 📊 使用說明

1. **開發時**: 完成每個子任務後在方框內打勾 `[x]`
2. **每完成一個子階段**: 更新「進度總覽」的完成數量
3. **每完成一個階段**: 在階段標題後打勾 `[x]`
4. **遇到問題**: 在子任務下方記錄 bug 或注意事項
5. **測試**: 每個子階段都有對應的測試，參考 `demon_block_test_plan.md`

---

## 🧪 測試方案快速參考

**完整測試計劃**: `docs/features/demon_block_test_plan.md`

### 測試執行時機
- **階段 1 完成後**: 執行 15 個單元測試
- **階段 2 完成後**: 執行 20 個單元測試 + 整合測試
- **階段 3 完成後**: 執行 12 個視覺測試 + FPS 測試
- **階段 4 完成後**: 執行 15 個整合測試
- **階段 5**: 執行完整功能測試 + 性能測試

### 快速測試指令
```bash
# 單元測試
flutter test test/demon_*.dart

# 覆蓋率
flutter test --coverage

# 整合測試
flutter test integration_test/demon_block_*.dart

# 性能測試
flutter run --profile  # 然後打開 DevTools
```

### 測試覆蓋率目標
- 單元測試: > 90%
- 整合測試: 100%
- 手動測試: > 90%

---

## 📝 備註欄

### 已知問題
- (記錄開發過程中發現的問題)
- 使用格式: `[DEMON-XXX] 描述`

### 參數調整記錄
- (記錄難度曲線、性能參數的調整)
- 例如: `觸發公式從 n^1.2 調整為 n^1.15`

### 測試結果
- (記錄關鍵測試的數據)
- 生成時間: _____ ms (目標: < 50ms)
- FPS: _____ (目標: 60)
- 記憶體: _____ MB (目標: < 20 MB)
- 計時器精度: _____ ms (目標: < 100ms)
