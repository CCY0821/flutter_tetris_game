# 階段 2 手動測試指南

## 🎯 測試目標

驗證惡魔方塊的觸發系統與分數加成機制：
1. ✅ 惡魔方塊在達到分數門檻時自動生成
2. ✅ 鎖定惡魔方塊後啟動 3× 分數加成
3. ✅ 分數加成持續 10 秒後自動過期
4. ✅ 加成期間的得分確實是 3 倍
5. ✅ 多個惡魔方塊可以觸發（最多 15 次）

---

## 📝 測試前準備

### ⚠️ 重要：無需修改代碼

**階段 2 已完全整合到遊戲中，直接運行即可測試！**

不需要像階段 1 那樣修改 `game_state.dart` 或使用測試攔截器。

---

## 🎮 執行測試

### 1. 啟動遊戲

```bash
flutter run -d windows  # Windows
# 或
flutter run -d emulator-5554  # Android 模擬器
```

### 2. 準備記分板

建議在旁邊準備一個記事本或手機計算機，用於驗證分數計算。

---

## ✅ 測試檢查清單

### 測試 1：第一次觸發（10,000 分）

**操作：**
1. 開始遊戲
2. 正常遊玩，累積分數到 10,000 分左右
3. 觀察 Next Piece 預覽區域

**預期結果：**
- ✅ 達到 10,000 分時，下一個方塊變成金色惡魔方塊
- ✅ 控制台顯示：
  ```
  [DemonSpawnManager] Spawn #1 triggered at score 10000 (threshold: 10000)
  [DemonSpawnManager] Next threshold: 22974
  ```
- ✅ 預覽區域顯示金色的 10 格不規則方塊

**如果失敗：**
- 檢查是否真的達到 10,000 分（查看遊戲畫面分數）
- 檢查控制台是否有錯誤訊息
- 確認階段 1 已正確實現（惡魔方塊基礎功能）

---

### 測試 2：鎖定惡魔方塊啟動加成

**操作：**
1. 讓金色惡魔方塊下落並鎖定到棋盤上
2. 觀察控制台日誌

**預期結果：**
- ✅ 惡魔方塊鎖定後，控制台顯示：
  ```
  [GameLogic] Demon block locked! Score multiplier activated (×3 for 10s)
  [GameState] Score multiplier activated! Duration: 10s
  ```
- ✅ 分數加成啟動（雖然可能沒有 UI 顯示，但會在日誌中看到）

**如果失敗：**
- 檢查 `game_logic.dart:101-106` 的惡魔方塊檢測邏輯
- 確認惡魔方塊的 `isDemon` getter 返回 true

---

### 測試 3：驗證 3× 分數加成效果

**操作：**
1. 在分數加成啟動後的 10 秒內
2. 消除 1 行（通常為 100 分）
3. 記錄實際獲得的分數

**預期結果：**
- ✅ 消除 1 行獲得 300 分（100 × 3）
- ✅ 消除 2 行獲得 600 分（200 × 3）
- ✅ 消除 3 行獲得 2,400 分（800 × 3）
- ✅ 消除 4 行獲得 2,400 分（800 × 3）或更多（如果有 combo）

**驗證方法：**
1. 記下加成啟動前的總分：例如 10,500 分
2. 消除 1 行
3. 記下加成後的總分：應該是 10,800 分（增加 300）

**如果失敗：**
- 檢查 `game_logic.dart:136-138` 的分數計算
- 確認 `scoreMultiplier` 是 3.0 而非 1.0
- 檢查是否有其他分數修改器干擾（例如符文效果）

---

### 測試 4：分數加成 10 秒後過期

**操作：**
1. 鎖定惡魔方塊啟動加成
2. 等待 10 秒不要消行
3. 10 秒後消除 1 行

**預期結果：**
- ✅ 10 秒後，控制台顯示：
  ```
  [GameState] Score multiplier expired
  ```
- ✅ 10 秒後消除 1 行只獲得 100 分（不再是 300 分）
- ✅ `scoreMultiplier` 回到 1.0

**驗證方法：**
1. 啟動加成後，暫停遊戲
2. 等待 10 秒（實際時間）
3. 恢復遊戲並消除 1 行
4. 確認獲得的分數是正常值（100 分）而非 3 倍（300 分）

**如果失敗：**
- 檢查 `checkMultiplierExpiry()` 是否被正確調用
- 確認計時器邏輯沒有暫停遊戲時的 bug

---

### 測試 5：分數加成疊加（Stacking）

**操作：**
1. 觸發第一個惡魔方塊（10,000 分）
2. 鎖定後啟動 10 秒加成
3. 在 10 秒內，繼續遊玩達到 22,974 分
4. 觸發第二個惡魔方塊並鎖定

**預期結果：**
- ✅ 第二個惡魔方塊鎖定後，控制台顯示：
  ```
  [GameState] Score multiplier stacked! Total time: XXs
  ```
- ✅ 加成時間延長（例如從剩餘 5 秒變成 15 秒）
- ✅ 分數倍數仍然是 3.0（不會變成 6.0 或 9.0）

**如果失敗：**
- 檢查 `startScoreMultiplier()` 的疊加邏輯（game_state.dart:336-350）

---

### 測試 6：第二次觸發（22,974 分）

**操作：**
1. 繼續遊玩，累積分數到 23,000 分左右
2. 觀察是否生成第二個惡魔方塊

**預期結果：**
- ✅ 達到 22,974 分時，下一個方塊變成惡魔方塊
- ✅ 控制台顯示：
  ```
  [DemonSpawnManager] Spawn #2 triggered at score 22974 (threshold: 22974)
  [DemonSpawnManager] Next threshold: 37372
  ```
- ✅ 再次鎖定後啟動 10 秒加成

**如果失敗：**
- 檢查 `_checkDemonSpawn()` 是否在每次得分後調用
- 確認 `DemonSpawnManager` 的計數邏輯正確

---

### 測試 7：連續觸發驗證（3-5 次）

**操作：**
1. 繼續遊玩，嘗試觸發 3-5 次惡魔方塊
2. 記錄每次觸發的分數門檻

**預期觸發分數：**
1. ✅ #1: 10,000 分
2. ✅ #2: 22,974 分
3. ✅ #3: 37,372 分
4. ✅ #4: 52,780 分
5. ✅ #5: 68,986 分

**預期結果：**
- ✅ 每次達到門檻時都生成惡魔方塊
- ✅ 門檻值遞增（符合 n^1.2 公式）
- ✅ 每次鎖定都啟動 10 秒加成

**如果失敗：**
- 檢查 `shouldSpawn()` 的防重複邏輯
- 確認分數門檻計算正確

---

### 測試 8：軟降/硬降也有加成

**操作：**
1. 啟動分數加成後
2. 使用軟降（下方向鍵）
3. 使用硬降（空白鍵）
4. 觀察獲得的分數

**預期結果：**
- ✅ 軟降每格獲得 3 分（正常 1 分 × 3）
- ✅ 硬降每格獲得 6 分（正常 2 分 × 3）
- ✅ 所有得分動作都受到加成影響

**如果失敗：**
- 檢查 `game_logic.dart:266-268` (軟降)
- 檢查 `game_logic.dart:294-296` (硬降)

---

### 測試 9：15 次上限測試（可選）

**操作：**
1. 使用作弊或快速刷分方法，觸發 15 次惡魔方塊
2. 嘗試觸發第 16 次

**預期結果：**
- ✅ 第 15 次觸發後，控制台顯示：
  ```
  [DemonSpawnManager] Next threshold: MAX_REACHED
  ```
- ✅ 即使分數繼續增加，也不再生成惡魔方塊
- ✅ 第 15 次的觸發分數約為 257,816 分

**如果失敗：**
- 檢查 `DemonSpawnManager.maxSpawns` 是否為 15
- 確認 `shouldSpawn()` 正確處理上限

---

## 🧪 進階測試（可選）

### 測試 10：暫停/恢復遊戲

**操作：**
1. 啟動分數加成
2. 暫停遊戲 10 秒
3. 恢復遊戲

**預期結果（目前實現）：**
- ⚠️ 加成時間會在暫停時繼續流逝（因為使用 DateTime）
- ⚠️ 這是已知限制，未來可能改進

**備註：**
- 階段 2 沒有實現暫停保存功能
- 如需此功能，需額外開發（使用 `_pausedMultiplierRemaining`）

---

### 測試 11：性能測試

**操作：**
1. 長時間遊玩（10 分鐘以上）
2. 觸發多次惡魔方塊
3. 觀察遊戲流暢度

**預期結果：**
- ✅ 遊戲維持 60 FPS
- ✅ 沒有記憶體洩漏
- ✅ 分數計算沒有延遲

**如果失敗：**
- 使用 Flutter DevTools 檢查性能
- 運行單元測試中的性能測試

---

## 🐛 常見問題排查

### 問題 1：達到 10,000 分但沒有生成惡魔方塊

**可能原因：**
- `_checkDemonSpawn()` 沒有被調用
- `pieceProviderStack.push()` 失敗

**解決方案：**
1. 在 `game_logic.dart:438` 添加 `debugPrint`:
   ```dart
   debugPrint('[DEBUG] Current score: $gameState.score');
   if (gameState.demonSpawnManager.shouldSpawn(gameState.score)) {
     debugPrint('[DEBUG] Pushing demon provider!');
   ```
2. 檢查控制台是否有這些日誌
3. 確認階段 1 已正確實現

---

### 問題 2：分數加成沒有生效（仍然是 1 倍）

**可能原因：**
- `scoreMultiplier` 沒有正確設置
- 分數計算邏輯沒有應用 multiplier

**解決方案：**
1. 在鎖定惡魔方塊後，手動檢查：
   ```dart
   debugPrint('[DEBUG] scoreMultiplier = ${gameState.scoreMultiplier}');
   debugPrint('[DEBUG] multiplierEndTime = ${gameState.multiplierEndTime}');
   ```
2. 確認 `scoreMultiplier` 是 3.0
3. 檢查 `game_logic.dart:136-138` 的計算邏輯

---

### 問題 3：分數加成永不過期

**可能原因：**
- `checkMultiplierExpiry()` 沒有被調用
- 計時器邏輯錯誤

**解決方案：**
1. 檢查 `game_logic.dart:145, 267, 293` 是否都有調用
2. 手動調用測試：
   ```dart
   gameState.checkMultiplierExpiry();
   debugPrint('[DEBUG] After check: ${gameState.scoreMultiplier}');
   ```
3. 確認 `DateTime.now()` 邏輯正確

---

### 問題 4：第二次觸發門檻不正確

**可能原因：**
- `DemonSpawnManager` 的公式錯誤
- `_spawnCount` 沒有正確遞增

**解決方案：**
1. 運行單元測試：
   ```bash
   flutter test test/demon_block_phase2_test.dart
   ```
2. 檢查 `getNextThreshold()` 的計算
3. 確認 `_spawnCount` 在每次觸發後 +1

---

## 📊 預期觸發時間表

假設平均每分鐘 2,000 分的遊玩速度：

| 序號 | 觸發分數 | 預計時間 |
|------|----------|----------|
| #1   | 10,000   | 5 分鐘   |
| #2   | 22,974   | 11 分鐘  |
| #3   | 37,372   | 19 分鐘  |
| #4   | 52,780   | 26 分鐘  |
| #5   | 68,986   | 34 分鐘  |
| #15  | 257,816  | 129 分鐘 |

**備註：**
- 實際時間取決於玩家技術和消行速度
- 使用分數加成可以加快觸發速度

---

## ✅ 測試通過標準

如果以下所有項目都通過，階段 2 開發完成：

### 核心功能（必須通過）
- [x] 測試 1：第一次觸發（10,000 分）✓
- [x] 測試 2：鎖定惡魔方塊啟動加成 ✓
- [x] 測試 3：驗證 3× 分數加成效果 ✓
- [x] 測試 4：分數加成 10 秒後過期 ✓
- [x] 測試 6：第二次觸發（22,974 分）✓

### 進階功能（建議通過）
- [ ] 測試 5：分數加成疊加 ✓
- [ ] 測試 7：連續觸發驗證（3-5 次）✓
- [ ] 測試 8：軟降/硬降也有加成 ✓

### 可選功能
- [ ] 測試 9：15 次上限測試 ○
- [ ] 測試 10：暫停/恢復遊戲 ○
- [ ] 測試 11：性能測試 ○

**總計**: 11 項測試（5 項核心 + 3 項進階 + 3 項可選）

---

## 📸 測試截圖建議

建議截圖記錄：
1. 第一次觸發時的分數畫面（顯示 10,000 分）
2. 惡魔方塊在 Next Piece 預覽中的顯示
3. 控制台日誌顯示 `Demon block locked! Score multiplier activated`
4. 加成期間消除 1 行獲得 300 分的截圖
5. 加成過期後消除 1 行獲得 100 分的截圖
6. 連續觸發 3 次的控制台日誌

---

## 🎯 快速驗證流程（5 分鐘）

如果時間有限，可以使用這個簡化流程：

1. **啟動遊戲**
2. **快速刷分到 10,000** （使用 4 行消除 Tetris）
3. **觀察是否生成金色惡魔方塊** ← 關鍵檢查點
4. **鎖定惡魔方塊**
5. **檢查控制台是否顯示加成啟動** ← 關鍵檢查點
6. **消除 1 行，確認獲得 300 分** ← 關鍵檢查點
7. **等待 10 秒**
8. **再消除 1 行，確認獲得 100 分** ← 關鍵檢查點

如果以上 4 個關鍵檢查點都通過，階段 2 基本功能正常！

---

## 📞 需要幫助？

如果測試過程中遇到問題：
1. 檢查本文件的「常見問題排查」章節
2. 運行單元測試：`flutter test test/demon_block_phase2_test.dart`
3. 查看設計文檔：`docs/features/demon_block_system_design.md`
4. 檢查階段 1 是否正確實現

---

**最後更新**: 2025-11-02
**文檔版本**: 1.0
**對應階段**: 階段 2（觸發系統）
