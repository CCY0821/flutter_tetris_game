# 符文系統 PR 檢查清單

## 🎯 核心規則檢查

### ✅ 事件流/狀態機/批處理/時間凍結
- [ ] 事件流使用域內 Bus，只包含必要的 4 種事件：RuneCast, EffectStart, EffectEnd, EnergyChanged
- [ ] 狀態機實現簡化版本：empty, ready, cooling, active, disabled
- [ ] 批處理系統正確合併同幀操作，單次 apply + 重繪
- [ ] 單調時鐘在 Pause/Resume 和 App 背景切換時正確凍結

### ✅ 自然清行 vs 法術清行分流
- [ ] 批處理邏輯內正確標記 `spellRemoval=true/false`
- [ ] 法術清行不計分、不產生符文能量
- [ ] 自然清行正常觸發計分和能量產生
- [ ] Earthquake / Gravity Reset 造成的後續連鎖滿行算法術清行

### ✅ 特殊符文規則處理
- [ ] **Column Breaker**: 影子無效時施法失敗（不扣能量、不進冷卻）
- [ ] **Thunder Strike**: 空盤時退還能量 + 不進冷卻 + 失敗回饋
- [ ] **時間系互斥**: Time Slow/Stop/Blessed Combo 只能同時存在一個
- [ ] **單幀節流**: 以邏輯幀為單位，與渲染幀解耦

## 🧪 驗收測試場景

### ✅ 三種失敗提示區隔
- [ ] **能量不足**: 紅色短閃 + 輕震動
- [ ] **冷卻中**: 藍紫色節奏閃 + 無震動
- [ ] **時間系互斥**: 琥珀色閃 + 輕震動 + 固定提示「時間系效果互斥」

### ✅ 重播確定性 (Determinism)
- [ ] 固定 seed 下，相同操作序列產生一致結果
- [ ] 符文效果不依賴系統時間，使用單調時鐘
- [ ] 隨機效果（如 Thunder Strike）使用可控隨機數生成器

### ✅ 性能穩定性
- [ ] 60Hz 螢幕下 FPS 穩定在 60
- [ ] 120Hz 螢幕下單幀節流正常工作
- [ ] 批處理避免多次重繪，無 GC 抖動

## ⚠️ 風險熱點檢查

### 🔥 記憶體滲漏風險
- [ ] 事件監聽器在組件銷毀時正確退訂
- [ ] Timer 和 StreamSubscription 在 dispose 時正確取消
- [ ] 符文狀態更新不持有已銷毀 Widget 的引用

### 🔥 時間系統風險
- [ ] 符文冷卻使用單調時鐘，不受系統時間變化影響
- [ ] 暫停期間時效正確凍結，恢復後繼續倒計時
- [ ] App 切換背景時時間軸狀態正確保存

### 🔥 棋盤操作風險
- [ ] **Gravity Reset** 後當前方塊正確下移到合法位置
- [ ] 無合法位置時觸發 Game Over 檢查，不產生非法重疊
- [ ] **Earthquake** 只移動已鎖定方塊，不影響正在下落的當前方塊
- [ ] 批處理操作順序正確：法術清行 → 自然清行 → 重力處理

## 📋 程式碼審查要點

### ✅ 架構設計
- [ ] P0 架構保持簡潔，避免過度設計
- [ ] 熱路徑（棋盤操作）保持可變結構，避免不必要的 copy
- [ ] UI 層面的狀態使用不可變結構，便於測試

### ✅ 錯誤處理
- [ ] 所有符文執行都有明確的成功/失敗/退還結果
- [ ] 異常情況（如影子無效、空盤）有合理的降級處理
- [ ] 用戶可感知的錯誤有適當的視覺和觸覺反饋

### ✅ 測試覆蓋
- [ ] 單元測試覆蓋所有符文的核心邏輯
- [ ] 集成測試驗證批處理和事件流
- [ ] 性能測試確保 60FPS 穩定性

## 🚀 發佈前最終檢查

- [ ] 所有 10 種符文功能完整實現
- [ ] 符文選擇界面與遊戲內 UI 正常工作
- [ ] 持久化系統正確保存/載入符文配置
- [ ] Web/Android/iOS 三平台測試通過
- [ ] 符文說明頁面內容更新，包含具體行為描述

---

**注意**: 此檢查清單應在每次 PR 提交前逐項確認，確保符文系統的穩定性和一致性。